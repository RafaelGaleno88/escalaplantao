<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escala de Plantonistas</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<h1>Login - Escala de Plantonistas</h1>

<div id="login-section">
  <input type="text" id="login-usuario" placeholder="Usuário"><br>
  <input type="password" id="login-senha" placeholder="Senha"><br>
  <button onclick="login()">Entrar</button>
  <button onclick="mostrarCadastro()">Cadastrar Plantonista</button>
  <button onclick="mostrarRecuperarSenha()">Esqueceu a Senha?</button>
</div>

<div id="cadastro-section" style="display:none">
  <h2>Cadastro de Plantonista</h2>
  <input type="text" id="usuario" placeholder="Nome de Usuário"><br>
  <input type="password" id="senha" placeholder="Senha"><br>
  <input type="text" id="nome" placeholder="Nome Completo"><br>
  <input type="text" id="telefone" placeholder="Telefone"><br>
  <input type="text" id="crm" placeholder="CRM"><br>
  <input type="text" id="cpf" placeholder="CPF"><br>
  <input type="text" id="faculdade" placeholder="Faculdade"><br>
  <input type="text" id="anoFormacao" placeholder="Ano de Formação"><br>
  <input type="text" id="especialidade" placeholder="Especialidade (opcional)"><br>
  <input type="text" id="rqe" placeholder="RQE (opcional)"><br>
  <button onclick="cadastrarPlantonista()">Cadastrar</button>
  <button onclick="voltarLogin()">Voltar</button>
</div>

<div id="recuperar-section" style="display:none">
  <h2>Recuperar Senha</h2>
  <input type="text" id="recuperar-crm" placeholder="Informe seu CRM"><br>
  <input type="text" id="recuperar-cpf" placeholder="Informe seu CPF"><br>
  <input type="password" id="nova-senha" placeholder="Nova Senha"><br>
  <button onclick="recuperarSenha()">Alterar Senha</button>
  <button onclick="voltarLogin()">Voltar</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBPOVIXYbE7AuZotyiKJ6nAqeqxFyKAq54",
  authDomain: "plantao-escala.firebaseapp.com",
  projectId: "plantao-escala",
  storageBucket: "plantao-escala.appspot.com",
  messagingSenderId: "1060716642051",
  appId: "1:1060716642051:web:ea0fda88c5e06d2f50b336"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Criar admin inicial
firebase.database().ref('usuarios/RafaelGaleno').set({
  username: 'RafaelGaleno',
  password: 'Galeno123',
  cpf: 'admin',
  crm: 'admin',
  isAdmin: true
});

function login() {
  const usuario = document.getElementById('login-usuario').value;
  const senha = document.getElementById('login-senha').value;

  firebase.database().ref('usuarios/' + usuario).once('value', snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.password === senha) {
        alert('Login realizado com sucesso!');
        // Aqui futuramente direcionar para a escala
      } else {
        alert('Senha incorreta!');
      }
    } else {
      alert('Usuário não encontrado!');
    }
  });
}

function mostrarCadastro() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('cadastro-section').style.display = 'block';
}

function mostrarRecuperarSenha() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('recuperar-section').style.display = 'block';
}

function voltarLogin() {
  document.getElementById('cadastro-section').style.display = 'none';
  document.getElementById('recuperar-section').style.display = 'none';
  document.getElementById('login-section').style.display = 'block';
}

function cadastrarPlantonista() {
  const usuario = document.getElementById('usuario').value;
  const senha = document.getElementById('senha').value;
  const nome = document.getElementById('nome').value;
  const telefone = document.getElementById('telefone').value;
  const crm = document.getElementById('crm').value;
  const cpf = document.getElementById('cpf').value;
  const faculdade = document.getElementById('faculdade').value;
  const anoFormacao = document.getElementById('anoFormacao').value;
  const especialidade = document.getElementById('especialidade').value;
  const rqe = document.getElementById('rqe').value;

  if (!usuario || !senha || !nome || !crm || !cpf) {
    alert('Preencha os campos obrigatórios!');
    return;
  }

  firebase.database().ref('usuarios/' + usuario).set({
    username: usuario,
    password: senha,
    cpf: cpf,
    crm: crm,
    isAdmin: false
  });

  firebase.database().ref('plantonistas').push({
    nome: nome,
    usuario: usuario,
    telefone: telefone,
    crm: crm,
    cpf: cpf,
    faculdade: faculdade,
    anoFormacao: anoFormacao,
    especialidade: especialidade,
    rqe: rqe
  }).then(() => {
    alert('Cadastro realizado com sucesso!');
    voltarLogin();
  }).catch(error => {
    alert('Erro ao cadastrar: ' + error.message);
  });
}

function recuperarSenha() {
  const crm = document.getElementById('recuperar-crm').value;
  const cpf = document.getElementById('recuperar-cpf').value;
  const novaSenha = document.getElementById('nova-senha').value;

  firebase.database().ref('usuarios').once('value', snapshot => {
    let encontrado = false;
    snapshot.forEach(child => {
      const user = child.val();
      if (user.crm === crm && user.cpf === cpf) {
        firebase.database().ref('usuarios/' + child.key).update({ password: novaSenha });
        alert('Senha alterada com sucesso!');
        encontrado = true;
        voltarLogin();
      }
    });
    if (!encontrado) {
      alert('CRM ou CPF incorretos.');
    }
  });
}
</script>

</body>
</html>
